<!DOCTYPE html>
<html>

<head>
    <title>Conceder Permissão</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/permissao.css">
    <link rel="stylesheet" href="css/style-all.css">
</head>

<body style="background-color: #e8e9ea">
    <div class="cor-bg"></div>
    <header>
        <a href="index.html">
            <div id="div-header-logo">
                <img src="assets/index/renderwatch_somente_logo_white.png">
                <img class="renderwatch-header" src="assets/index/renderwatch_somente_palavra_white.png">
            </div>
        </a>
        <div class="menu">
            <ul>
                <div class="link">
                    <a href="perfil-download.html"><img class="perfil-configuracoes-icon"
                            src="assets/perfil/botaodownload.png"></a>
                    <li><a style="margin-left: 12px;" href="perfil-download.html">Download</a></li>
                </div>
                <div class="link">
                    <a href="perfil-relatorio.html"><img class="perfil-configuracoes-icon"
                            src="assets/perfil/relatorio (1).png" alt=""></a>
                    <li><a style="margin-left: 12px;" href="perfil-relatorio.html">Relatórios</a></li>
                </div>
                <div class="link">
                    <a href="perfil-configuracoes.html"><img class="perfil-configuracoes-icon"
                            src="assets/perfil/setting.png" alt=""></a>
                    <li><a href="perfil-configuracoes.html">Configurações</a></li>
                </div>
                <div class="link" onclick="logout()">
                    <span><img class="perfil-logout-icon" src="assets/perfil/log-out.png" alt=""></span>
                    <li><span>Sair</span></li>
                </div>
            </ul>
        </div>
    </header>
    <sidebar>
        <div class="sidebar">
            <ul>
                <li><a href="perfil-empresa.html" class="sidebar-element">
                        <div>Empresa</div>
                    </a></li>
                <li><a href="permissao.html" class="sidebar-element">
                        <div>Permissões</div>
                    </a></li>
                <li><a href="perfil-alertas.html" class="sidebar-element">
                        <div>Alertas</div>
                    </a></li>
                <li><a href="perfil-dashboard.html" class="sidebar-element">
                        <div>Dashboard</div>
                    </a></li>
                <li><a href="perfil-clusters.html" class="sidebar-element">
                        <div>Clusters</div>
                    </a></li>
                <li><a href="perfil-rede.html" class="sidebar-element">
                        <div>Rede</div>
                    </a></li>
                <li><a href="https://renderwatch.auvo.com.br/Login#signin" target="_blank" class="sidebar-element">
                        <div>Suporte</div>
                    </a></li>
            </ul>
        </div>
    </sidebar>
    <br><br><br>
    <main class="spaceTop">
        <h2>Permissão</h2>
        <form id="conceder-permissao-form">
            <label for="email">E-mail:</label>
            <input type="email" id="email" name="email" required>
            <br>
            <label for="permissao">Permissão administrador:</label>
            <input type="checkbox" id="permissao" name="permissao">
            <br>
            <button type="submit" onclick="atualizarFeed()">Conceder permissão</button>
        </form>
        <hr>
        <h2>Permissões Concedidas</h2>
        <table id="permissao-table">
            <thead>
                <tr>
                    <th>E-mail</th>
                    <th>Permissão</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                <!-- linhas da tabela vão ser adicionadas dinamicamente com javascript -->
            </tbody>
        </table>
    </main>
</body>

</html>

<!-- <script src="js/perfil-permissao.js"></script> -->
<script src="js/perfil-sidebar-header.js"></script>

<script>
    function listar() {
        fetch("/permissao/listar")
            .then(function (resposta) {
                if (resposta.ok) {
                    if (resposta.status == 204) {
                        var tbody = document.querySelector("#permissao-table tbody");
                        var mensagem = document.createElement("span");
                        mensagem.innerHTML = "Nenhum resultado encontrado.";
                        tbody.appendChild(mensagem);
                        throw "Nenhum resultado encontrado!!";
                    }

                    resposta.json().then(function (resposta) {
                        console.log("Dados recebidos: ", JSON.stringify(resposta));

                        var tbody = document.querySelector("#permissao-table tbody");
                        tbody.innerHTML = "";

                        for (let i = 0; i < resposta.length; i++) {
                            var publicacao = resposta[i];

                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${resposta[i].email}</td>
                                <td>
                                    <label>
                                        <input type="checkbox" ${resposta[i].adm !== 0 ? 'checked' : ''} disabled>
                                    </label>
                                </td>
                                <td>
                                    <button class="editar-button">Conceder</button>
                                    <button class="salvar-button" style="display: none;">Salvar</button>
                                    <button class="excluir-button">Tirar</button>
                                </td>
                            `;

                            // Adicione a linha à tabela
                            tbody.appendChild(tr);

                            const editarButton = tr.querySelector('.editar-button');
                            const salvarButton = tr.querySelector('.salvar-button');
                            const excluirButton = tr.querySelector('.excluir-button');
                            const salvarButtonTirar = tr.querySelector('.salvar-button');

                            editarButton.addEventListener('click', () => {
                                const checkbox = tr.querySelector('input[type="checkbox"]');
                                checkbox.disabled = false;
                                checkbox.focus();
                                editarButton.style.display = 'none';
                                excluirButton.style.display = 'none';
                                salvarButton.style.display = '';
                            });

                            salvarButton.addEventListener('click', () => {
                                const checkbox = tr.querySelector('input[type="checkbox"]');
                                const email = tr.querySelector('td:first-child').textContent;
                                const permissao = checkbox.checked ? 1 : 0; // Converte o valor booleano em um valor numérico

                                conceder(email, permissao); // Alteração na ordem dos parâmetros

                                checkbox.disabled = true;
                                salvarButton.style.display = 'none';
                                editarButton.style.display = '';
                                excluirButton.style.display = '';
                                salvarButtonTirar.style.display = 'none';

                            });

                            excluirButton.addEventListener('click', () => {
                                const checkbox = tr.querySelector('input[type="checkbox"]');
                                const email = tr.querySelector('td:first-child').textContent;
                                const permissao = checkbox.checked ? 1 : 0; // Converte o valor booleano em um valor numérico


                            });

                            salvarButtonTirar.addEventListener('click', () => {
                                const checkbox = tr.querySelector('input[type="checkbox"]');
                                const email = tr.querySelector('td:first-child').textContent;
                                const permissao = checkbox.checked ? 1 : 0; // Converte o valor booleano em um valor numérico
                                tirar(email, permissao);

                                checkbox.disabled = true;
                                salvarButton.style.display = 'none';
                                editarButton.style.display = '';
                                excluirButton.style.display = '';
                                salvarButtonTirar.style.display = 'none';

                            });



                        }
                    });
                } else {
                    throw 'Houve um erro na API!';
                }
            })
            .catch(function (resposta) {
                console.error(resposta);
            });
    }

    listar();

    function conceder(admEditar, emailEditar) {
        fetch(`/permissao/editar/${emailEditar}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                adm: admEditar
            })
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    window.alert('Permissão atualizada com sucesso!');
                    //window.location = '/permissao.html';
                } else if (resposta.status == 404) {
                    window.alert('Erro 404: Página não encontrada!');
                } else {
                    throw (
                        "Houve um erro ao tentar realizar a atualização da permissão! Código da resposta: " + resposta.status
                    );
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    function tirar(admEditar, emailEditar) {
        fetch(`/permissao/tirar/${emailEditar}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                adm: admEditar
            })
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    window.alert('Permissão atualizada com sucesso!');
                    //window.location = '/permissao.html';
                } else if (resposta.status == 404) {
                    window.alert('Erro 404: Página não encontrada!');
                } else {
                    throw (
                        "Houve um erro ao tentar realizar a atualização da permissão! Código da resposta: " + resposta.status
                    );
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

</script>